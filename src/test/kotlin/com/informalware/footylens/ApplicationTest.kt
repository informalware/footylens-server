package com.informalware.footylens

import com.informalware.footylens.data.Users
import com.informalware.footylens.plugins.configureRouting
import com.informalware.footylens.plugins.connectFooty
import com.informalware.footylens.plugins.users
import io.ktor.client.request.*
import io.ktor.client.statement.*
import io.ktor.http.*
import io.ktor.server.testing.*
import org.ktorm.dsl.deleteAll
import org.ktorm.dsl.insert
import kotlin.test.*

class ApplicationTest {
    @Test
    fun testHelloWorld() = testApplication {
        application { configureRouting() }
        client.get("/").apply {
            assertEquals(HttpStatusCode.OK, status)
            assertEquals("Hello, World!", bodyAsText())
        }
    }
    @Test
    fun testUsers() = testApplication {
        application {
            configureRouting()
        }

        val database = connectFooty(true)
        database.deleteAll(Users)
        database.insert(Users) {
            set(Users.username, "foo")
            set(Users.password, "12345678")
            set(Users.email, "foo@bar.baz")
            set(Users.display, "Foo")
            set(Users.bio, "Lorem ipsum")
        }

        client.get("/users/1").apply {
            assertEquals(HttpStatusCode.OK, status)
            print(bodyAsText())
        }
    }
}
