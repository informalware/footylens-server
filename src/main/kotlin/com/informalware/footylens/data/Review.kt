package com.informalware.footylens.data

import com.informalware.footylens.data.util.DateSerializer
import kotlinx.serialization.Serializable
import java.util.Date

/**
 * Enum usada para definir a avaliação de uma `Review` sobre uma partida
 * */
@Serializable
enum class Rating {
    TERRIBLE,
    BAD,
    OK,
    GOOD,
    AMAZING
}

/**
 * Função utilitária para ordenar `Rating`s de reviews
 * TERRIBLE = 0
 * BAD = 1
 * OK = 2
 * GOOD = 3
 * AMAZING = 4
 * @return número entre 0 e 4 indicando o nível da partida
 * */
fun Rating.getOrder(): Int = when(this) {
    Rating.TERRIBLE -> 0
    Rating.BAD -> 1
    Rating.OK -> 2
    Rating.GOOD -> 3
    Rating.AMAZING -> 4
}

/**
 * Objeto que representa uma review de uma partida
 * @property id número de identificação da ID no banco de dados
 * @property matchId número de identificação da partida a qual essa review se refere
 * @property matchId número de identificação do usuário que escreveu essa review
 * @property rating avaliação quantitativa dada pelo usuário
 * @property review avaliação qualitativa escrita pelo usuário
 * @property creationDate data de criação da review
 * @property lastModifiedDate data da última vez que a review foi modificada
 * */
@Serializable
object Reviews : Table<Nothing>("t_review") , Summarizable {
    val id = uint("id").primaryKey()
    val matchId = uint("match_id")
    val userId = varchar("user_id")
    var rating = varchar("rating")
    var review = varchar("review")
    val creationDate = datetime("creation_date")
    var lastModifiedDate = datetime("last_modified_date")

    override fun getSummary(maxLength: UInt): String {
        return if (this.review.length.toUInt() < maxLength) {
            this.review
        } else {
            val summary = this.review.substring(0, maxLength.toInt())
            "$summary..."
        }
    }

    fun toSummarized(maxLength: UInt = MAX_SUMMARY_LENGTH): SummarizedReview = SummarizedReview(id, matchId, userId, rating, this.getSummary(maxLength))
}

@Serializable
object SummarizedReviews : Table<Nothing>("t_summarized_review") {
    val id = uint("id").primaryKey()
    val matchId = uint("match_id")
    val userId = varchar("user_id")
    var rating = varchar("rating")
    var review = varchar("review")
}

object ReviewRegistryRequests : Table<Nothing>("t_review_registry_request") {
    val matchId = uint("match_id")
    val userId = varchar("user_id")
    var rating = varchar("rating")
    var review = varchar("review")
}