package com.informalware.footylens.data

import kotlinx.serialization.Serializable
import org.ktorm.schema.*

/**
 * Objeto que representa um usuário armazenado no banco de dados. Usuários serão indexados pelo `username`
 * @property username nome do usuário, usado como PK pelo DB
 * @property display nome de exibição do usuário usado no frontend
 * @property email email do usuário
 * @property bio descrição do usuário exibida no seu perfil no frontend
 * @property followingList lista de pessoas que o usuário segue
 * @property reviewsList lista de reviews feitas
 * @property commentariesList list de comentários feitos
 *
 * */
@Serializable
object Users : Table<Nothing>("User") {
    val id = int("id").primaryKey()
    val username = varchar("username")
    val password = varchar("password")
    val display = varchar("display")
    val email = varchar("email")
    val bio = varchar("bio")

    fun getPartial(fields: List<String>): Map<String, String> {
        val result = mutableMapOf<String, String>()

        for (field in fields) {
            var data: String? = null
            when (field) {
                "username" -> data = this.username
                "display" -> data = this.display
                "email" -> data = this.email
                "bio" -> data = this.bio
            }

            if (data == null) continue
            else result[field] = data
        }
        return result
    }
}

/**
 * Estrutura recebida pelo endpoint de registro para cadastrar um novo usuário
 * */
@Serializable
object UserRegistryRequests : Table<Nothing>("User") {
    val username = varchar("username")
    val password = varchar("password")
    val display = varchar("display")
    val email = varchar("email")
    /**
     * Produz um usuário para ser adicionado no registro
     * */
    fun toUser(): User = User(
        username,
        password,
        display,
        email,
        "",
    )
}